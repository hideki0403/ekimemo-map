import{s as m,c as y,a as S,C as G,b as V}from"./store.b15c8b6a.js";import{r as N,f as O,g as q,o as d,c as C,a as f,t as p,n as _,h as u,_ as x,b as A,w as I,F as P,i as z,j as b,d as T}from"./entry.a85db09a.js";import{d as $}from"./dayjs.min.668a802a.js";import{_ as F}from"./MeButton.f86411f0.js";class D{watchId;callbacks;active;constructor(){this.watchId=null,this.callbacks=[],this.active=N(!1)}get isActive(){return this.active}startWatch(t){t&&this.callbacks.push(t),!this.watchId&&(this.watchId=navigator.geolocation.watchPosition(e=>{this.callbacks.forEach(s=>s(e))}),this.active.value=!0,console.log("start watch"))}stopWatch(){this.watchId&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null,this.active.value=!1,this.callbacks=[],console.log("stop watch"))}getCurrentPosition(){return new Promise((t,e)=>{navigator.geolocation.getCurrentPosition(t,e)})}}const L=new D;function H(n,t,e,s){let i=Math.PI*t/180,o=Math.PI*n/180,r=Math.PI*s/180,a=Math.PI*e/180,c=(i-r)/2,h=(o-a)/2;return 6378137*2*Math.asin(Math.sqrt(Math.pow(Math.sin(h),2)+Math.cos(o)*Math.cos(a)*Math.pow(Math.sin(c),2)))}function W(n){return n<1e3?`${n.toFixed(0)}m`:`${(n/1e3).toFixed(1)}km`}function E(n,t=!1){return t?`${Math.floor(n/60)}分${n%60}秒`:`${Math.floor(n/60)}:${(n%60).toString().padStart(2,"0")}`}function B(n,t=!1){const e=t?`最後に通知してから${E(m.get("cooldownSeconds"),!0)}が経過しました`:`${n.station.name} が最寄り駅になりました`,s={body:W(n.distance),renotify:!0,tag:"nearestStation",vibrate:[100,50,100]};J(e,s),console.log("showStationNotification",e,s)}function J(n,t){navigator.serviceWorker.controller?.postMessage({type:"notificationCreate",payload:{title:n,options:t}})}function j(n,t,e){return t>=n.south&&t<=n.north&&e>=n.west&&e<=n.east}class k{depth;code;region;segmentName;station;left;right;constructor(t,e,s){this.depth=t,this.code=e.code,this.region=s}async build(t,e){return await this.buildTree(t,e),this}async buildTree(t,e){if(t.segment){this.segmentName=t.segment;return}if(this.station=await y.stations.get(t.code),!this.station)throw new Error(`Station ${t.code} not found`);if(!j(this.region,this.station.lat,this.station.lng))throw new Error(`Station ${t.code} is out of region`);const s=this.depth%2===0;if(t.left){const i=e.get(t.left);if(!i)throw new Error(`Node ${t.left} not found`);this.left=await new k(this.depth+1,i,{north:s?this.region.north:this.station.lat,south:this.region.south,east:s?this.station.lng:this.region.east,west:this.region.west}).build(i,e)}if(t.right){const i=e.get(t.right);if(!i)throw new Error(`Node ${t.right} not found`);this.right=await new k(this.depth+1,i,{north:this.region.north,south:s?this.region.south:this.station.lat,east:this.region.east,west:s?this.station.lng:this.region.west}).build(i,e)}}clear(){this.station=void 0,this.left?.clear(),this.right?.clear(),this.left=void 0,this.right=void 0}async get(){if(this.station)return this.station;if(!this.segmentName)throw new Error("Segment name not found");const t=await y.treeSegments.get(this.segmentName);if(!t)throw new Error(`Tree segment ${this.segmentName} not found`);if(t.root!==this.code)throw new Error("Root node is not matched");const e=new Map;t.node_list.forEach(i=>e.set(i.code,i));const s=e.get(t.root);if(!s)throw new Error(`Root node ${t.root} not found`);if(await this.buildTree(s,e),!this.station)throw new Error("Station not found");return this.station}}class K{root;lastPosition;lastChangedDate;currentStation;searchList=[];reactiveSearchList=N([]);serviceAvailable=!1;locked=!1;constructor(){}async initialize(t="root"){if(!await y.treeSegments.count())return this;const e=await y.treeSegments.get(t),s=new Map;if(!e)throw new Error(`Tree segment ${t} not found`);e.node_list.forEach(o=>s.set(o.code,o));const i=s.get(e.root);if(!i)throw new Error(`Root node ${e.root} not found`);return this.root=await new k(0,i,{north:90,south:-90,east:180,west:-180}).build(i,s),this.serviceAvailable=!0,this}clear(){this.root?.clear(),this.root=void 0}async updateLocation(t,e,s=0){const i=m.get("stationResultCount");if(i<1)throw new Error("maxResults must be greater than 0");if(!this.root)throw new Error("Tree not initialized");if(this.searchList.length>=i&&this.lastPosition?.latitude===t&&this.lastPosition?.longitude===e||this.locked)return;this.locked=!0,this.searchList=[],await this.search(this.root,t,e,i,s);const o=this.searchList[0].station,r=o.code!==this.currentStation?.code;this.currentStation=o,this.lastPosition={latitude:t,longitude:e};let a;if(r){const c=new Date;this.lastChangedDate=c;const h=await S.accessLog.get(o.id),l={lastAccess:c.toISOString(),accessCount:(h?.accessCount??0)+1};a=h?.lastAccess,h?await S.accessLog.update(o.id,l):(l.firstAccess=c.toISOString(),l.id=o.id,await S.accessLog.add(l))}this.reactiveSearchList.value=await Promise.all(this.searchList.map(async(c,h)=>{const l=await S.accessLog.get(c.station.id),g={station:c.station,distance:H(t,e,c.station.lat,c.station.lng),lastAccess:l?.lastAccess?new Date(l.lastAccess):null,accessCount:l?.accessCount??0,isNew:!l?.accessCount,index:h+1};if(h===0&&r){const w=m.get("cooldownSeconds"),v=$().diff(a??0,"second")<w;(!a||w&&!v)&&B(g)}return g})),this.locked=!1}async updateRectRegion(t,e){if(!this.root)throw new Error("Tree not initialized");const s=[];return await this.searchRect(this.root,t,s,e),s}get getReactive(){return this.reactiveSearchList}getAllNearStations(){return this.searchList.map(t=>t.station)}getNearStations(t){return this.searchList?(t<0&&(t=0),t>this.searchList.length&&(t=this.searchList.length),this.searchList.slice(0,t).map(e=>e.station)):[]}async search(t,e,s,i,o=0){const r={value:0,threshold:0},a=await t.get(),c=Math.sqrt(Math.pow(a.lat-e,2)+Math.pow(a.lng-s,2));let h=-1,l=this.searchList.length;if(l>0&&c<this.searchList[l-1].distance)for(h=l-1;h>0&&!(c>=this.searchList[h-1].distance);)h--;else l||(h=0);h>=0&&(this.searchList.splice(h,0,{station:a,distance:c}),l>=i&&this.searchList[l].distance>o&&this.searchList.pop());const g=t.depth%2===0;r.value=g?s:e,r.threshold=g?a.lng:a.lat;const w=r.value<r.threshold?t.left:t.right;w&&await this.search(w,e,s,i,o);const v=r.value<r.threshold?t.right:t.left,R=this.searchList;v&&Math.abs(r.value-r.threshold)<Math.max(R[R.length-1].distance,o)&&await this.search(v,e,s,i,o)}async searchRect(t,e,s,i){const o=await t.get();if(i&&s.length>=i)return;j(e,o.lat,o.lng)&&s.push(o);const r=[],a=t.depth%2===0?e.west<o.lng:e.south<o.lat,c=t.depth%2===0?o.lng<e.east:o.lat<e.north;t.left&&a&&r.push(this.searchRect(t.left,e,s,i)),t.right&&c&&r.push(this.searchRect(t.right,e,s,i)),await Promise.all(r)}}const M=await new K().initialize(),Q=O({__name:"MeStationSimple",props:{data:{}},setup(n){const t=n,e=N(null);let s=0,i=!1;q(t,()=>{o()});function o(){t.data.lastAccess&&!i&&r()}o();function r(){const a=m.get("cooldownSeconds"),c=m.get("enableStationReminder");if(!a){e.value=null;return}i=!0;const h=$().diff($(t.data.lastAccess),"second");if(h<a){e.value=E(a-h),setTimeout(r,1e3);return}if(c&&t.data.index===1){e.value=E(a-s),s++,a-s<0&&(s=0,B(t.data,!0)),setTimeout(r,1e3);return}e.value=null,i=!1}return(a,c)=>(d(),C("div",{class:_([a.$style.root,"_panel transition-colors"])},[f("div",{class:_([a.$style.index,{[a.$style.accessed]:!a.data.isNew,[a.$style.cooldown]:u(e)}])},p(t.data.index),3),f("div",{class:_(a.$style.main)},[f("div",null,p(t.data.station.name),1),f("div",{class:_(a.$style.sub)},p(u(W)(t.data.distance)),3)],2),f("div",null,p(u(e)),1)],2))}}),U="_root_6oc7k_1",X="_index_6oc7k_9",Y="_cooldown_6oc7k_20",Z="_accessed_6oc7k_24",tt="_main_6oc7k_29",et="_sub_6oc7k_34",st={root:U,index:X,cooldown:Y,accessed:Z,main:tt,sub:et},it={$style:st},ot=x(Q,[["__cssModules",it]]),at={class:"_gap"},lt=O({__name:"index",setup(n){const t=L.isActive,e=M.getReactive;function s(){t.value?L.stopWatch():L.startWatch(o=>{M.updateLocation(o.coords.latitude,o.coords.longitude)})}function i(){L.getCurrentPosition().then(async o=>{M.updateLocation(o.coords.latitude,o.coords.longitude)})}return(o,r)=>(d(),C(P,null,[A(F,{primary:u(t),onClick:s},{default:I(()=>[u(t)?(d(),b(u(V),{key:1})):(d(),b(u(G),{key:0})),T(" 位置情報"+p(u(t)?"ON":"OFF"),1)]),_:1},8,["primary"]),A(F,{onClick:i},{default:I(()=>[T("検索")]),_:1}),f("div",at,[(d(!0),C(P,null,z(u(e),a=>(d(),b(ot,{key:a.station.id,data:a},null,8,["data"]))),128))])],64))}});export{lt as default};
